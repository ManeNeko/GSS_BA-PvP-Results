<!DOCTYPE html>
<html lang="ja">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>登録画像一覧</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
	<style>
		/* カスタムスクロールバー */
		#image-grid-container::-webkit-scrollbar {
			width: 10px;
		}

		#image-grid-container::-webkit-scrollbar-track {
			background: #f1f1f1;
		}

		#image-grid-container::-webkit-scrollbar-thumb {
			background: #ccc;
			border-radius: 4px;
		}

		#image-grid-container::-webkit-scrollbar-thumb:hover {
			background: #bbb;
		}
	</style>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen">

	<div class="mx-auto p-8 max-w-4xl w-full">
		<!-- 全体を囲むカード -->
		<div class="bg-white rounded-lg shadow-2xl flex flex-col" style="height: 90vh;">

			<!-- 操作ボタン用の領域 -->
			<div class="flex-shrink-0 border-b border-gray-200 p-6">

				<div class="flex flex-wrap gap-3 items-center">
					<button id="export-btn"
						class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors w-48 text-center">
						バックアップ作成
					</button>
					<label for="import-zip" id="import-label"
						class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg cursor-pointer transition-colors w-48 text-center">
						バックアップ復元
					</label>
					<input type="file" id="import-zip" accept=".zip" class="hidden">
					<button id="delete-all-btn"
						class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors ml-auto">
						すべて削除
					</button>
				</div>
			</div>

			<!-- 登録済み画像用の領域-->
			<div id="image-grid-container" class="flex-grow overflow-y-auto p-6">
				<div id="image-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
				</div>
			</div>
		</div>
	</div>

	<script>
		const dbName = 'BA_PvP';
		const storeName = 'img_result';
		const dbVersion = 1;

		const imageGrid = document.getElementById('image-grid');
		const imageGridContainer = document.getElementById('image-grid-container');
		const deleteAllBtn = document.getElementById('delete-all-btn');
		const exportBtn = document.getElementById('export-btn');
		const importZipInput = document.getElementById('import-zip');

		// Button styles
		const CLEAN_BTN_CLASSES = ['bg-gray-700', 'hover:bg-gray-800'];
		const DIRTY_BTN_CLASSES = ['bg-blue-500', 'hover:bg-blue-600'];

		async function openAppDB() {
			return await idb.openDB(dbName, dbVersion, {
				upgrade(db) {
					if (!db.objectStoreNames.contains(storeName)) {
						const store = db.createObjectStore(storeName, { keyPath: 'id', autoIncrement: true });
						store.createIndex('name', 'name', { unique: true });
					}
					if (!db.objectStoreNames.contains('trim_list')) {
						db.createObjectStore('trim_list');
					}
				}
			});
		}

		async function loadAndDisplayImages() {
			try {
				const db = await openAppDB();
				const items = await db.getAll(storeName);
				imageGrid.innerHTML = '';

				if (items.length === 0) {
					imageGridContainer.innerHTML = '<div class="flex items-center justify-center h-full"><p class="text-gray-500 text-center">登録されている画像はありません。</p></div>';
					return;
				}

				imageGridContainer.innerHTML = '<div class="flex items-center justify-center h-full"><p class="text-gray-500 text-center">画像をソート中...</p></div>';

				// 画像の横幅を取得
				const itemsWithDimensions = await Promise.all(items.map(item =>
					new Promise(resolve => {
						if (!item.image) {
							resolve({ item, width: 0 });
							return;
						}
						const img = new Image();
						img.onload = () => {
							resolve({ item, width: img.width }); // 横幅取得
							URL.revokeObjectURL(img.src);
						};
						img.onerror = () => {
							resolve({ item, width: 0 });
							URL.revokeObjectURL(img.src);
						};
						img.src = URL.createObjectURL(item.image);
					})
				));

				// 名前でソート
				itemsWithDimensions.sort((a, b) => {
					const nameA = (a.item.name || '').toLowerCase();
					const nameB = (b.item.name || '').toLowerCase();
					if (nameA < nameB) return -1;
					if (nameA > nameB) return 1;
					return 0;
				});

				// 名前順を記録
				itemsWithDimensions.forEach((entry, idx) => {
					entry.nameOrder = idx;
				});

				// 横幅でソート
				itemsWithDimensions.sort((a, b) => {
					if (a.width !== b.width) return a.width - b.width; // 横幅で昇順
					return a.nameOrder - b.nameOrder;
				});

				const sortedItems = itemsWithDimensions.map(x => x.item);

				if (!imageGridContainer.contains(imageGrid)) {
					imageGridContainer.innerHTML = '';
					imageGridContainer.appendChild(imageGrid);
				}
				imageGrid.innerHTML = '';

				for (const item of sortedItems) {
					createImageCard(item);
				}
			} catch (error) {
				console.error('Failed to load images:', error);
				imageGridContainer.innerHTML = '<div class="flex items-center justify-center h-full"><p class="text-red-500 text-center">画像の読み込みに失敗しました。</p></div>';
			}
		}

		function createImageCard(item) {
			const card = document.createElement('div');
			card.className = 'bg-white rounded-lg shadow-md overflow-hidden flex flex-col border border-gray-200';
			card.dataset.id = item.id;

			const imgLink = document.createElement('a');
			const imgSrc = item.image ? URL.createObjectURL(item.image) : '#';
			imgLink.href = imgSrc;
			imgLink.target = '_blank';
			const img = document.createElement('img');
			img.src = imgSrc;
			img.className = 'w-full h-32 object-contain bg-gray-50';
			imgLink.appendChild(img);

			const contentDiv = document.createElement('div');
			contentDiv.className = 'p-3 flex flex-col flex-grow';

			const nameInput = document.createElement('input');
			nameInput.type = 'text';
			nameInput.value = item.name;
			nameInput.className = 'w-full mb-2 px-2 py-1 text-sm border-2 border-gray-200 rounded-md focus:outline-none focus:border-blue-400';

			const btnGroup = document.createElement('div');
			btnGroup.className = 'mt-auto grid grid-cols-2 gap-2';

			const renameButton = document.createElement('button');
			renameButton.textContent = '変更';
			renameButton.className = 'text-sm text-white font-bold py-1 px-2 rounded-md transition-colors';
			renameButton.classList.add(...CLEAN_BTN_CLASSES);
			renameButton.onclick = () => handleRename(item.id, nameInput.value, renameButton);

			nameInput.addEventListener('input', () => {
				renameButton.classList.remove(...CLEAN_BTN_CLASSES);
				renameButton.classList.add(...DIRTY_BTN_CLASSES);
			});

			const deleteButton = document.createElement('button');
			deleteButton.textContent = '削除';
			deleteButton.className = 'text-sm bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-1 px-2 rounded-md transition-colors';
			deleteButton.onclick = () => handleDelete(item.id);

			btnGroup.appendChild(renameButton);
			btnGroup.appendChild(deleteButton);
			contentDiv.appendChild(nameInput);
			contentDiv.appendChild(btnGroup);
			card.appendChild(imgLink);
			card.appendChild(contentDiv);
			imageGrid.appendChild(card);

			const observer = new MutationObserver((mutationsList, obs) => {
				for (const mutation of mutationsList) {
					if (mutation.type === 'childList') {
						mutation.removedNodes.forEach(node => {
							if (node === card && imgSrc.startsWith('blob:')) {
								URL.revokeObjectURL(imgSrc);
								obs.disconnect();
							}
						});
					}
				}
			});
			observer.observe(imageGrid, { childList: true });
		}

		async function handleRename(id, newName, button) {
			const trimmedName = newName.trim();
			try {
				if (!trimmedName) {
					alert('名前を入力してください。');
					return;
				}
				const db = await openAppDB();
				const existing = await db.getFromIndex(storeName, 'name', trimmedName);
				if (existing && existing.id !== id) {
					alert(`エラー: 名前「${trimmedName}」は既に使用されています。`);
					return;
				}

				const tx = db.transaction(storeName, 'readwrite');
				const store = tx.objectStore(storeName);
				const itemToUpdate = await store.get(id);

				if (itemToUpdate) {
					itemToUpdate.name = trimmedName;
					await store.put(itemToUpdate);
					await tx.done;
					alert('名前を変更しました。');
				} else {
					alert('更新対象のデータが見つかりませんでした。');
				}
			} catch (error) {
				console.error('Rename failed:', error);
				alert('名前の変更中にエラーが発生しました。');
			} finally {
				button.classList.remove(...DIRTY_BTN_CLASSES);
				button.classList.add(...CLEAN_BTN_CLASSES);
			}
		}

		async function handleDelete(id) {
			if (!confirm('本当にこの画像を削除しますか？')) return;
			try {
				const db = await openAppDB();
				await db.delete(storeName, id);
				const cardToRemove = imageGrid.querySelector(`[data-id='${id}']`);
				if (cardToRemove) cardToRemove.remove();
				if (imageGrid.children.length === 0) {
					imageGridContainer.innerHTML = '<div class="flex items-center justify-center h-full"><p class="text-gray-500 text-center">登録されている画像はありません。</p></div>';
				}
			} catch (error) {
				console.error('Delete failed:', error);
				alert('画像の削除中にエラーが発生しました。');
			}
		}

		async function handleDeleteAll() {
			if (!confirm('本当にすべての画像を削除しますか？この操作は元に戻せません。')) return;
			try {
				const db = await openAppDB();
				await db.clear(storeName);
				imageGridContainer.innerHTML = '<div class="flex items-center justify-center h-full"><p class="text-gray-500 text-center">すべての画像を削除しました。</p></div>';
				alert('すべての画像を削除しました。');
			} catch (error) {
				console.error('Delete all failed:', error);
				alert('全件削除中にエラーが発生しました。');
			}
		}

		async function handleExport() {
			try {
				const db = await openAppDB();
				const items = await db.getAll(storeName);
				if (items.length === 0) return alert('エクスポートする画像がありません。');

				const zip = new JSZip();
				for (const item of items) {
					if (item.image instanceof Blob) {
						const fileExtension = item.image.type.split('/')[1] || 'png';
						zip.file(`${item.name}.${fileExtension}`, item.image);
					}
				}

				// Trim設定のバックアップ
				const trimConfig = await db.get('trim_list', 'trim_config');
				if (trimConfig) {
					zip.file('trim_config.json', JSON.stringify(trimConfig));
				}

				const zipBlob = await zip.generateAsync({ type: "blob" });
				const link = document.createElement('a');
				link.href = URL.createObjectURL(zipBlob);
				link.download = 'exported_images.zip';
				document.body.appendChild(link);
				link.click();
				document.body.removeChild(link);
				URL.revokeObjectURL(link.href);
			} catch (error) {
				console.error('Export failed:', error);
				alert('エクスポート中にエラーが発生しました。');
			}
		}

		async function handleImport(event) {
			const file = event.target.files[0];
			if (!file) return;

			try {
				const db = await openAppDB();
				const zip = await JSZip.loadAsync(file);
				const promises = [];

				zip.forEach((relativePath, zipEntry) => {
					if (!zipEntry.dir) {
						const promise = (async () => {
							if (zipEntry.name === 'trim_config.json') {
								const content = await zipEntry.async('string');
								try {
									const config = JSON.parse(content);
									await db.put('trim_list', config, 'trim_config');
								} catch (e) {
									console.error('Failed to parse trim_config.json', e);
								}
								return;
							}

							const blob = await zipEntry.async('blob');
							const baseName = zipEntry.name.replace(/\.[^/.]+$/, '');

							let finalName = baseName;
							let counter = 2;
							let isUnique = false;
							while (!isUnique) {
								const existing = await db.getFromIndex(storeName, 'name', finalName);
								if (existing) {
									finalName = `${baseName}_${String(counter).padStart(4, '0')}`;
									counter++;
								} else {
									isUnique = true;
								}
							}
							await db.add(storeName, { name: finalName, image: blob });
						})();
						promises.push(promise);
					}
				});

				await Promise.all(promises);
				alert(`${promises.length}件の画像をインポートしました。`);
				loadAndDisplayImages();
			} catch (error) {
				console.error('Import failed:', error);
				alert('インポート中にエラーが発生しました。');
			} finally {
				importZipInput.value = '';
			}
		}

		document.addEventListener('DOMContentLoaded', loadAndDisplayImages);
		deleteAllBtn.addEventListener('click', handleDeleteAll);
		exportBtn.addEventListener('click', handleExport);
		importZipInput.addEventListener('change', handleImport);

	</script>

</body>

</html>